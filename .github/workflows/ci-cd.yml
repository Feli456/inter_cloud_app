name: CI/CD InterCloud App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”½ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”¨ Build Docker image
      run: docker build -t inter_cloud-web .

    - name: ğŸ§ª Test Docker image (optional)
      run: docker run --rm inter_cloud-web php -v

    - name: ğŸ§¹ Clean up old resources (optional)
      run: docker system prune -af

    - name: ğŸš€ Deploy to Kubernetes
      run: |
        kubectl apply -f mysql-deployment.yaml
        kubectl apply -f mysql-service.yaml
        kubectl apply -f web-deployment.yaml
        kubectl apply -f web-service.yaml
